{% extends "base.html" %}

{% block title %}Live NFL Scores{% endblock %}

{% block content %}
    <h1 class="page-title">Live NFL Scores</h1>
    <div class="scoreboard-grid">
        <div id="live-scoreboard" class="scoreboard-grid"></div>
        <h2 id="last-week-header" style="display:none;">Last Week's Scores</h2>
        <div id="last-week-scoreboard" class="scoreboard"></div>
    </div>

    <!-- Floating Box for User's Score Summary -->
    <div id="user-score-box" class="floating-box">
        <h3>Your Score for Week <span id="current-week-number"></span></h3>
        <div id="user-total-points">Total Points: 0</div>
        <table id="user-picks-table">
            <thead>
                <tr>
                    <th>Game</th>
                    <th>Your Pick</th>
                    <th>Confidence</th>
                    <th>Points</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="user-picks-list">
                <!-- Picks will be populated here -->
            </tbody>
        </table>
    </div>

    <style>
        /* Existing styles */
        .floating-box {
            position: fixed;
            top: 110px;
            right: 20px;
            width: 450px;
            max-height: 90vh;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .floating-box h3 {
            margin-top: 0;
        }

        #user-picks-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        #user-picks-table th, #user-picks-table td {
            padding: 5px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        #user-picks-table th {
            background-color: #f2f2f2;
            color: black;
            font-weight: bold;
        }
    </style>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const liveScoreboard = document.getElementById('live-scoreboard');
        const lastWeekHeader = document.getElementById('last-week-header');
        const lastWeekScoreboard = document.getElementById('last-week-scoreboard');
        const userTotalPoints = document.getElementById('user-total-points');
        const userPicksList = document.getElementById('user-picks-list');
        const currentWeekElement = document.getElementById('current-week-number');
        const previousScores = {};
        const defaultLogo = '/static/images/default.png';

        // Function to update NFL scoreboard
        function fetchLiveScores() {
            fetch('/stream-live-scores')
                .then(response => response.json())
                .then(data => {
                    console.log('Fetched live scores:', data);
                    updateScoreboard(data);
                })
                .catch(error => console.error('Error fetching live scores:', error));
        }

        function updateScoreboard(data) {
            liveScoreboard.innerHTML = '';  // Clear current scoreboard
            lastWeekScoreboard.innerHTML = '';  // Clear last week's scoreboard

            if (data.live_games && data.live_games.length > 0) {
                data.live_games.forEach(game => renderGame(game, liveScoreboard));
                lastWeekHeader.style.display = 'none';
            } else if (data.last_week_games && data.last_week_games.length > 0) {
                lastWeekHeader.style.display = 'block';
                data.last_week_games.forEach(game => renderGame(game, lastWeekScoreboard));
            } else {
                liveScoreboard.innerHTML = '<div class="no-games">No games currently available.</div>';
                lastWeekHeader.style.display = 'none';
            }
        }

        function renderGame(game, container) {
            const gameKey = game.home_team + ' vs ' + game.away_team;

            let gameElement = document.getElementById(gameKey);
            if (!gameElement) {
                gameElement = document.createElement('div');
                gameElement.id = gameKey;
                gameElement.classList.add('game-card');
                container.appendChild(gameElement);
            }

            const homeTeamLogo = `/static/images/${game.home_team}.png`;
            const awayTeamLogo = `/static/images/${game.away_team}.png`;
            const possessionHighlight = game.possession === game.home_team ? 'possession-highlight' : '';
            const awayPossessionHighlight = game.possession === game.away_team ? 'possession-highlight' : '';

            gameElement.innerHTML = `
                <div class="team-logos">
                    <div class="team-logo ${possessionHighlight}">
                        <img src="${homeTeamLogo}" alt="${game.home_team} logo" onerror="this.onerror=null;this.src='${defaultLogo}'">
                    </div>
                    <div class="team-logo ${awayPossessionHighlight}">
                        <img src="${awayTeamLogo}" alt="${game.away_team} logo" onerror="this.onerror=null;this.src='${defaultLogo}'">
                    </div>
                </div>
                <div class="score">
                    ${game.home_team} ${game.home_score} - ${game.away_team} ${game.away_score}
                    <span class="game-status">${game.status}</span>
                </div>
                <div class="game-details">
                    <div>Clock: ${game.clock} (Q${game.period})</div>
                    <div>Possession: ${game.possession || 'None'}</div>
                    <div>Down & Distance: ${game.down ? `Down ${game.down} & ${game.distance} yards` : 'N/A'}</div>
                    <div>Yard Line: ${game.yardLine || 'N/A'}</div>
                </div>
            `;
        }

        // Fetch and update user score summary
        function updateUserScoreBox() {
            const currentWeek = 10;
            const previousWeek = currentWeek - 1;

            fetch(`/user_score_summary?format=json&week=${previousWeek}`)
                .then(response => response.json())
                .then(data => {
                    userTotalPoints.innerText = 'Total Points: ' + data.user_total_score;
                    currentWeekElement.innerText = previousWeek;

                    userPicksList.innerHTML = '';  // Clear existing rows

                    data.game_picks.forEach(game => {
                        if (game.pick) {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${game.home_team} vs ${game.away_team}</td>
                                <td>${game.pick.team_picked}</td>
                                <td>${game.pick.confidence}</td>
                                <td>${game.pick.points_earned || 0}</td>
                                <td>${game.status}</td>
                            `;
                            userPicksList.appendChild(row);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error fetching user score summary:', error);
                });
        }

        // Initial fetches and intervals for updates
        fetchLiveScores();
        setInterval(fetchLiveScores, 30000);  // Update live scores every 30 seconds
        updateUserScoreBox();
        setInterval(updateUserScoreBox, 300000);  // Update user score every 5 minutes
      });
    </script>
{% endblock %}
